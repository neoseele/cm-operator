scrape_configs:

- job_name: 'kubernetes-pods'
  kubernetes_sd_configs:
    - role: pod
  relabel_configs:
    - source_labels: [__meta_kubernetes_pod_annotation_cmoperator_io_scrape]
      action: keep
      regex: true
    - source_labels:
      - __meta_kubernetes_pod_annotationpresent_cmoperator_io_path
      - __meta_kubernetes_pod_annotation_cmoperator_io_path
      action: replace
      target_label: __metrics_path__
      regex: true;(.+)
    - source_labels: [__address__, __meta_kubernetes_pod_annotation_cmoperator_io_port]
      action: replace
      regex: ([^:]+)(?::\d+)?;(\d+)
      replacement: $1:$2
      target_label: __address__
    - action: labelmap
      regex: __meta_kubernetes_pod_label_(.+)
    - source_labels: [__meta_kubernetes_namespace]
      action: replace
      target_label: kubernetes_namespace
    - source_labels: [__meta_kubernetes_pod_name]
      action: replace
      target_label: kubernetes_pod_name

- job_name: 'kubernetes-nodes-cadvisor'
  metrics_path: /metrics/cadvisor
  kubernetes_sd_configs:
    - role: node
  relabel_configs:
    - source_labels: [__meta_kubernetes_node_annotation_cmoperator_io_scrape]
      action: keep
      regex: true
    - source_labels: [__address__]
      action: replace
      regex: ([^:]+)(?::\d+)?
      replacement: $1:10255
      target_label: __address__
    - action: labelmap
      regex: __meta_kubernetes_node_label_(.+)

- job_name: kube-dns
  kubernetes_sd_configs:
    - role: endpoints
  relabel_configs:
    - action: labelmap
      regex: __meta_kubernetes_service_label_(.+)
    - action: replace
      regex: ([^:]+)(?::\d+)?
      replacement: $1:10055
      source_labels:
      - __address__
      target_label: __address__
    - action: keep
      regex: kube-system
      source_labels:
      - __meta_kubernetes_namespace
    - action: keep
      regex: kube-dns
      source_labels:
      - __meta_kubernetes_service_name
    - action: replace
      source_labels:
      - __meta_kubernetes_namespace
      target_label: namespace
    - action: replace
      source_labels:
      - __meta_kubernetes_pod_name
      target_label: pod

- job_name: kube-dnsmasq
  kubernetes_sd_configs:
    - role: endpoints
  relabel_configs:
    - action: labelmap
      regex: __meta_kubernetes_service_label_(.+)
    - action: replace
      regex: ([^:]+)(?::\d+)?
      replacement: $1:10054
      source_labels:
      - __address__
      target_label: __address__
    - action: keep
      regex: kube-system
      source_labels:
      - __meta_kubernetes_namespace
    - action: keep
      regex: kube-dns
      source_labels:
      - __meta_kubernetes_service_name
    - action: replace
      source_labels:
      - __meta_kubernetes_namespace
      target_label: namespace
    - action: replace
      source_labels:
      - __meta_kubernetes_pod_name
      target_label: pod